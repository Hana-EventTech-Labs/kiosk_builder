# .github/workflows/auto-release.yml
name: Auto Dual Exe Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r kiosk-builder-app/requirements.txt
    
    - name: Extract version from tag
      id: get_version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: powershell
    
    - name: Update version in code
      run: |
        python scripts/update_version.py ${{ steps.get_version.outputs.version }}
    
    - name: Build both executables
      run: |
        python scripts/build_all.py
    
    - name: Verify builds
      run: |
        if (!(Test-Path "dist/super-kiosk-builder.exe")) {
          Write-Error "super-kiosk-builder.exe not found"
          exit 1
        }
        if (!(Test-Path "dist/super-kiosk.exe")) {
          Write-Error "super-kiosk.exe not found"  
          exit 1
        }
        
        $builderSize = (Get-Item "dist/super-kiosk-builder.exe").Length
        $kioskSize = (Get-Item "dist/super-kiosk.exe").Length
        
        Write-Host "✅ Build verification successful:"
        Write-Host "📁 super-kiosk-builder.exe: $($builderSize.ToString('N0')) bytes"
        Write-Host "📁 super-kiosk.exe: $($kioskSize.ToString('N0')) bytes"
      shell: powershell
    
    - name: Generate release notes
      id: release_notes
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $date = Get-Date -Format "yyyy-MM-dd"
        
        $releaseNotes = @"
        ## 🚀 Super Kiosk v$version 출시

        ### 📦 포함된 파일
        - **super-kiosk-builder.exe**: 키오스크 설정 편집 프로그램 (관리자용)
        - **super-kiosk.exe**: 키오스크 실행 프로그램 (사용자용)

        ### 📋 주요 특징
        - 🔄 **자동 업데이트**: Builder에서 자동으로 최신 버전 확인 및 업데이트
        - 🎨 **통합 UI**: 직관적인 키오스크 설정 인터페이스
        - 📱 **반응형 디자인**: 다양한 화면 크기 지원
        - 🔐 **보안**: 사용자 인증 및 권한 관리

        ### 🛠 기술 정보
        - **빌드 일시**: $date
        - **버전**: $version
        - **Python**: 3.11
        - **UI 프레임워크**: PySide6
        "@
        
        # GitHub Output으로 설정 (멀티라인 처리)
        "release_notes<<EOF" >> $env:GITHUB_OUTPUT
        $releaseNotes >> $env:GITHUB_OUTPUT
        "EOF" >> $env:GITHUB_OUTPUT
      shell: powershell
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/super-kiosk-builder.exe
          dist/super-kiosk.exe
        body: ${{ steps.release_notes.outputs.release_notes }}
        name: "Super Kiosk ${{ steps.get_version.outputs.tag }}"
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build artifacts (for debugging)
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: build-artifacts-${{ steps.get_version.outputs.version }}
        path: |
          dist/
          *.log
        retention-days: 30