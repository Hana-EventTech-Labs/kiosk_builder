# .github/workflows/auto-release.yml
name: Auto Dual Exe Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r kiosk-builder-app/requirements.txt
    
    - name: Extract version from tag
      id: get_version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: powershell
    
    - name: Update version in code
      run: |
        python scripts/update_version.py ${{ steps.get_version.outputs.version }}
    
    - name: Build both executables
      run: |
        python scripts/build_all.py
    
    - name: Verify builds
      run: |
        if (!(Test-Path "dist/super-kiosk-builder.exe")) {
          Write-Error "super-kiosk-builder.exe not found"
          exit 1
        }
        if (!(Test-Path "dist/super-kiosk.exe")) {
          Write-Error "super-kiosk.exe not found"  
          exit 1
        }
        
        $builderSize = (Get-Item "dist/super-kiosk-builder.exe").Length
        $kioskSize = (Get-Item "dist/super-kiosk.exe").Length
        
        Write-Host "âœ… Build verification successful:"
        Write-Host "ğŸ“ super-kiosk-builder.exe: $($builderSize.ToString('N0')) bytes"
        Write-Host "ğŸ“ super-kiosk.exe: $($kioskSize.ToString('N0')) bytes"
      shell: powershell
    
    - name: Generate release notes
      id: release_notes
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $date = Get-Date -Format "yyyy-MM-dd"
        
        $releaseNotes = @"
        ## ğŸš€ Super Kiosk v$version ì¶œì‹œ

        ### ğŸ“¦ í¬í•¨ëœ íŒŒì¼
        - **super-kiosk-builder.exe**: í‚¤ì˜¤ìŠ¤í¬ ì„¤ì • í¸ì§‘ í”„ë¡œê·¸ë¨ (ê´€ë¦¬ììš©)
        - **super-kiosk.exe**: í‚¤ì˜¤ìŠ¤í¬ ì‹¤í–‰ í”„ë¡œê·¸ë¨ (ì‚¬ìš©ììš©)

        ### ğŸ“‹ ì£¼ìš” íŠ¹ì§•
        - ğŸ”„ **ìë™ ì—…ë°ì´íŠ¸**: Builderì—ì„œ ìë™ìœ¼ë¡œ ìµœì‹  ë²„ì „ í™•ì¸ ë° ì—…ë°ì´íŠ¸
        - ğŸ¨ **í†µí•© UI**: ì§ê´€ì ì¸ í‚¤ì˜¤ìŠ¤í¬ ì„¤ì • ì¸í„°í˜ì´ìŠ¤
        - ğŸ“± **ë°˜ì‘í˜• ë””ìì¸**: ë‹¤ì–‘í•œ í™”ë©´ í¬ê¸° ì§€ì›
        - ğŸ” **ë³´ì•ˆ**: ì‚¬ìš©ì ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬

        ### ğŸ›  ê¸°ìˆ  ì •ë³´
        - **ë¹Œë“œ ì¼ì‹œ**: $date
        - **ë²„ì „**: $version
        - **Python**: 3.11
        - **UI í”„ë ˆì„ì›Œí¬**: PySide6
        "@
        
        # GitHub Outputìœ¼ë¡œ ì„¤ì • (ë©€í‹°ë¼ì¸ ì²˜ë¦¬)
        "release_notes<<EOF" >> $env:GITHUB_OUTPUT
        $releaseNotes >> $env:GITHUB_OUTPUT
        "EOF" >> $env:GITHUB_OUTPUT
      shell: powershell
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/super-kiosk-builder.exe
          dist/super-kiosk.exe
        body: ${{ steps.release_notes.outputs.release_notes }}
        name: "Super Kiosk ${{ steps.get_version.outputs.tag }}"
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build artifacts (for debugging)
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: build-artifacts-${{ steps.get_version.outputs.version }}
        path: |
          dist/
          *.log
        retention-days: 30